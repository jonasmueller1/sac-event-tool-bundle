/**
 * SAC Event Tool Web Plugin for Contao
 * Copyright (c) 2008-2017 Marko Cupic
 * @package sac-event-tool-bundle
 * @author Marko Cupic m.cupic@gmx.ch, 2017-2018
 * @link https://sac-kurse.kletterkader.com
 *///Provides methods for filtering the event list
var EventFilter={options:null,globalEventId:0,$eventList:0,$filterBoard:null,$ctrlEventYear:null,$ctrlOrganizers:null,$ctrlSearch:null,$ctrlEventType:null,$ctrlDateStart:null,$ctrlDateStartHidden:null,queueRequest:function(){"use strict";var a=this;a.showLoadingIcon(),a.resetEventList(),a.globalEventId++;var b=a.globalEventId;window.setTimeout(function(){b===a.globalEventId&&a.fireXHR()},a.options.delay)},resetEventList:function(){"use strict",$(".alert-no-results-found").remove(),$(".event-item").each(function(){$(this).hide(),$(this).removeClass("visible")})},showLoadingIcon:function(){"use strict";var a=this;$(".loading-icon-lg").remove(),a.$eventList.first().append(a.options.loadingIcon.html)},hideLoadingIcon:function(){"use strict",$(".loading-icon-lg").remove()},listEventsStartingFromDate:function(a){"use strict";var b=this,c=/^(.*)-(.*)-(.*)$/g,d=c.exec(a);if(d){var e=new Date(d[3],d[2]-1,d[1]),f=Math.round(e.getTime()/1e3);if(!isNaN(f)){b.$ctrlDateStartHidden.val(f),b.$ctrlDateStartHidden.attr("value",f),b.queueRequest();return}}b.$ctrlDateStartHidden.attr("value","0"),b.$ctrlDateStartHidden.val("0"),b.queueRequest()},fireXHR:function(){"use strict";var a=this,b=0,c=[];$(".event-item").each(function(){c.push($(this).attr("data-id"))});var d=a.$ctrlEventType.val();a.sessionStorageSet("ctrl_eventType",d);var e=a.$ctrlOrganizers.val();a.sessionStorageSet("ctrl_organizers",JSON.stringify(e));var f=a.$ctrlDateStartHidden,g=Math.round(f.val())>0?f.val():0;g=Math.round(g);var h=a.$ctrlSearch.val();a.sessionStorageSet("ctrl_search",h);var i=a.options.xhr.action.split("?"),j=$.ajax({method:"post",url:i[0],data:{action:i[1],year:a.getUrlParam("year"),REQUEST_TOKEN:a.options.requestToken,ids:JSON.stringify(c),eventType:d,organizers:JSON.stringify(e),searchterm:h,startDate:g},dataType:"json"});j.done(function(c){c&&(a.hideLoadingIcon(),$.each(c.filter,function(a,c){$('.event-item[data-id="'+c+'"]').each(function(){$(this).show(),$(this).addClass("visible"),b++})}),b===0&&$(".alert-no-results-found").length===0&&a.$eventList.first().append(a.options.noResult.html),$("html, body").animate({scrollTop:a.$filterBoard.offset().top},500))}),j.fail(function(b){a.hideLoadingIcon(),window.console.log(b)})},getUrlParam:function(a){"use strict";var b=(new RegExp("[?&]"+a+"=([^&#]*)")).exec(window.location.href);return b===null?0:b[1]||0},sessionStorageGet:function(a){"use strict";var b=this;try{if(typeof sessionStorage!="undefined"){var c=sessionStorage.getItem(a+"_"+b.options.filterBoardId);return c===""||c===null||c==="undefined"?null:c}}catch(d){window.console.log("Session Storage is disabled or not supported for this browser.")}return null},sessionStorageSet:function(a,b){"use strict";var c=this;try{typeof window.sessionStorage!="undefined"&&sessionStorage.setItem(a+"_"+c.options.filterBoardId,b)}catch(d){window.console.log("Session Storage is disabled or not supported for this browser.")}return null},resetForm:function(){"use strict";var a=this;a.sessionStorageSet("ctrl_organizers",JSON.stringify([])),a.sessionStorageSet("ctrl_search",""),a.sessionStorageSet("ctrl_eventType",0),a.sessionStorageSet("ctrl_eventYear",0),a.sessionStorageSet("ctrl_dateStart","");var b=window.location.href.split("?");window.location.href=b[0]},initialize:function(a,b){"use strict";var c=this;c.$eventList=a,c.options=b,c.$filterBoard=$("#eventFilterBoard"),c.$ctrlOrganizers=$("#ctrl_organizers"),c.$ctrlSearch=$("#ctrl_search"),c.$ctrlEventType=$("#ctrl_eventType"),c.$ctrlEventYear=$("#ctrl_eventYear"),c.$ctrlDateStart=$("#ctrl_dateStart"),c.$ctrlDateStartHidden=$("#ctrl_dateStartHidden"),$(".reset-form").click(function(a){a.preventDefault(),c.resetForm()}),$(".close-event-filter-button").click(function(){c.$filterBoard.closest(".mod_article").addClass("d-none"),$(".toggle-filter-btn").removeClass("d-none"),$(".toggle-filter-btn").addClass("d-block"),$("html, body").animate({scrollTop:c.$filterBoard.offset().bottom},500)}),$(".toggle-filter-btn").click(function(){c.$filterBoard.closest(".mod_article").removeClass("d-none"),$(".toggle-filter-btn").addClass("d-none"),$(".toggle-filter-btn").removeClass("d-block"),$("html, body").animate({scrollTop:c.$filterBoard.offset().top},500)});if(c.getUrlParam("organizer")!==0){var d=c.getUrlParam("organizer").split(",");c.sessionStorageSet("ctrl_organizers",JSON.stringify(d));var e=window.location.href.split("?");window.location.replace(e[0]);return}var f={placeholder:"organisierende Gruppe"};c.$ctrlOrganizers.select2(f),c.$ctrlOrganizers.on("select2:unselect",function(){window.setTimeout(function(){c.$ctrlOrganizers.select2("close")},100)}),c.$ctrlOrganizers.on("select2:opening select2:closing",function(a){var b=$(this).parent().find(".select2-search__field");b.prop("disabled",!0)}),c.sessionStorageGet("ctrl_search")!==null&&c.$ctrlSearch.val(c.sessionStorageGet("ctrl_search"));var g=JSON.parse(c.sessionStorageGet("ctrl_organizers"));g!==null&&g.length&&(c.$ctrlOrganizers.val(g),c.$ctrlOrganizers.trigger("change")),c.sessionStorageGet("ctrl_eventType")!==null&&c.$ctrlEventType.val(c.sessionStorageGet("ctrl_eventType")),c.$ctrlEventYear.on("change",function(){var a=window.location.href.split("?");window.location.href=a[0]+"?year="+$(this).prop("value")}),c.$ctrlEventType.on("change",function(){c.queueRequest()}),c.$ctrlOrganizers.on("change",function(){c.sessionStorageSet("ctrl_organizers",JSON.stringify($(this).val())),c.queueRequest()}),c.$ctrlSearch.on("keyup",function(){c.queueRequest()});var h=c.sessionStorageGet("ctrl_dateStart");h===null&&(h=c.$ctrlDateStart.val()),c.$ctrlDateStart.val(h),c.listEventsStartingFromDate(h);var i={format:"dd-mm-yyyy",autoclose:!0,maxViewMode:0,language:"de"};c.getUrlParam("year")>0&&(i.startDate="01-01-"+c.getUrlParam("year"),i.endDate="31-12-"+c.getUrlParam("year")),$(".filter-board .input-group.date").datepicker(i).on("changeDate",function(){var a=c.$ctrlDateStart.val();c.listEventsStartingFromDate(a),c.sessionStorageSet("ctrl_dateStart",a)});var j=[];$(".event-item").each(function(){if($(this).attr("data-event-type")!==""){var a=$(this).attr("data-event-type").split(",");jQuery.each(a,function(a,b){j.push(b)})}}),j=jQuery.unique(j),c.$ctrlEventType.find("option").each(function(){if($(this).attr("value")>0){var a=$(this).attr("value");jQuery.inArray(a,j)<0&&$(this).remove()}}),c.resetEventList(),c.queueRequest()}};