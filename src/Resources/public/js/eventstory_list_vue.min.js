"use strict";document.addEventListener("DOMContentLoaded",function(event){});class ItemWatcher{constructor(elId,opt){const defaults={params:{listModuleId:null,readerModuleId:null,itemIds:[],perPage:4,language:"en"}};let options=_.merge(defaults,opt);new Vue({el:elId,data:{options:options,listContent:"",readerContent:"",itemIds:[],currentPage:null,currentItemIndex:null,currentItemId:null},created:function created(){let self=this;self.itemIds=self.options.params.itemIds;let page=self.getUrlParam("page_e"+self.options.params.listModuleId,null);self.currentPage=page===null?1:parseInt(page);document.onkeydown=function(e){self._checkKeyPress(e)};window.setTimeout(function(){let modal=document.querySelector(elId+" .modal");if(modal){modal.addEventListener("hidden.bs.modal",function(event){self.currentItemId=null;self.readerContent=""})}},1e3);let eventStoryId=null;if(false!==(eventStoryId=self.getUrlParam("showEventStory",false))){self.currentItemId=eventStoryId;self.currentItemIndex=self.getCurrentItemIndex();self.currentPage=self.getCurrentPage();self.fetchReaderContent();self.fetchReaderContent()}},watch:{currentPage:function(val){let self=this;self.fetchList()},currentItemId:function(val){let self=this;if(self.currentItemId!==null){self.currentItemIndex=self.getCurrentItemIndex();self.currentPage=self.getCurrentPage();self.fetchReaderContent()}}},methods:{fetchList:function fetchList(){let self=this;let url="/_mc_cc_api/07d49d1bc6e9fd8bcaabead11b4f75e0/show?id="+self.options.params.listModuleId+"&page_e"+self.options.params.listModuleId+"="+self.currentPage+"&_locale="+self.options.params.language;fetch(url,{method:"GET",headers:{"x-requested-with":"XMLHttpRequest"}}).then(function(res){return res.json()}).then(function(json){$(elId+" .list-container").css("opacity",0);self.listContent=json.compiledHTML;$(elId+" .list-container").fadeTo("slow",1)}).then(function(){$(window).trigger("vueupdate");let cssSelectorStr=elId+" .pagination .link, "+elId+" .pagination .first, "+elId+" .pagination .last, "+elId+" .pagination .previous, "+elId+" .pagination .next";$(cssSelectorStr).off("click");$(cssSelectorStr).click(function(e){e.stopPropagation();e.preventDefault();let href=$(this).prop("href");let regexp=new RegExp("page_e"+self.options.params.listModuleId+"=([\\d]+)");let match=regexp.exec(href);let page=match?match[1]:1;self.currentPage=parseInt(page)})}).then(function(){let cssSelectorStr=elId+" a.item-reader-link";$(cssSelectorStr).off("click");$(cssSelectorStr).click(function(e){e.stopPropagation();e.preventDefault();let href=e.currentTarget.getAttribute("href");let regex=/^(.*)(\/)([\d]+)/i;let match=regex.exec(href);if(match.length<4){console.log("Aborted! Could not load content. No item id found.");return}let itemId=match[3];if(!options.params.readerModuleId){console.log("Aborted! Could not load content. No reader module id found.");return}itemId=parseInt(itemId);if(itemId===self.currentItemId){self.fetchReaderContent();return}self.currentItemId=parseInt(itemId)})})},fetchReaderContent:function fetchReaderContent(){let self=this;let referer=btoa(window.location.href);let url="/_mc_cc_api/07d49d1bc6e9fd8bcaabead11b4f75e0/show?id="+self.options.params.readerModuleId+"&items="+self.currentItemId+"&referer="+referer+" &_locale="+self.options.params.language;fetch(url,{method:"GET",headers:{"x-requested-with":"XMLHttpRequest"}}).then(function(res){return res.json()}).then(function(json){self.readerContent=json.compiledHTML}).then(function(){let elModal=document.querySelector(elId+" .modal");let modal=bootstrap.Modal.getOrCreateInstance(elModal);if(!self.isModalOpen()){modal.show()}}).then(function(){self._initLightbox()})},hasNextItem:function hasNextItem(){let self=this;if(typeof self.itemIds[self.currentItemIndex+1]!=="undefined"){return true}return false},goToNextItem:function goToNextItem(){let self=this;self.currentItemId=parseInt(self.itemIds[self.currentItemIndex+1])},hasPrevItem:function hasPrevItem(){let self=this;if(typeof self.itemIds[self.currentItemIndex-1]!=="undefined"){return true}return false},getCurrentItemIndex:function getCurrentItemIndex(){let self=this;return self.itemIds.indexOf(parseInt(self.currentItemId))},getCurrentPage:function getCurrentPage(){let self=this;return Math.floor(parseInt(self.currentItemIndex)/parseInt(self.options.params.perPage))+1},goToPrevItem:function goToPrevItem(){let self=this;self.currentItemId=parseInt(self.itemIds[self.currentItemIndex-1])},_initLightbox:function _initLightbox(){if("undefined"!==typeof GLightbox){(function(){"use strict";document.querySelectorAll("a[data-lightbox]").forEach(element=>{if(!!element.dataset.lightbox){element.setAttribute("data-gallery",element.dataset.lightbox)}});GLightbox({selector:"a[data-lightbox]"})})()}else{jQuery(function($){$("a[data-lightbox]").map(function(){$(this).colorbox({loop:false,rel:$(this).attr("data-lightbox"),maxWidth:"95%",maxHeight:"95%"})})})}},getUrlParam:function getUrlParam(parameter,defaultvalue){let self=this;var urlparameter=defaultvalue;if(window.location.href.indexOf(parameter)>-1){urlparameter=self._getUrlVars()[parameter]}return urlparameter},_getUrlVars:function _getUrlVars(){var vars={};var parts=window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(m,key,value){vars[key]=value});return vars},_checkKeyPress:function _checkKeyPress(e){let self=this;e=e||window.event;if(e.keyCode=="37"){if(self.isModalOpen()&&self.hasPrevItem()){self.goToPrevItem()}}else if(e.keyCode=="39"){if(self.isModalOpen()&&self.hasNextItem()){self.goToNextItem()}}},isModalOpen:function isModalOpen(){if(document.querySelector(elId+" .modal.show")){return true}return false}}})}}