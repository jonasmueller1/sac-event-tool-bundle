{{ addJsToHead('https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.min.js') }}
{{ addJsToHead('assets/contao-component-vue-js/vue/dist/vue.min.js|static') }}
{{ addJsToHead('bundles/markocupicsaceventtool/js/eventlist_vue.js|static') }}

<div id="tour-list">
    <span v-if="itemsTotal > 0" class="text-muted"><small>Zu deiner Suchanfrage wurden <% itemsTotal %> Events gefunden. </small></span>
    <span v-if="blnIsBusy === true" class="ms-2 text-success"><small>Lade events...</small></span>
    <div class="event-container row">
        <div v-for="(row, index) of rows" class="event-item event-item-tour event col-12 col-lg-6" v-bind:data-id="row.id" v-bind:data-event-type="row.tourTypesIds">

            <div class="event-list-inner-box d-flex p-3 mb-3">
                <!-- left col -->
                <div class="event-list-tour-col-1" data-has-event-href="true" v-bind:data-href="row.eventUrl">
                    <div class="event-list-badge-wrapper me-4 rounded-circle d-flex align-items-center justify-content-center">
                        <div class="d-flex flex-column">
                            <span class="event-list-badge-day text-center lh-1">
                            <strong v-html="row.startDateDay"></strong>
                            </span>
                            <span class="event-list-badge-month text-uppercase text-center font-weight-bolder lh-1 pb-2">
                                <strong v-html="row.startDateMonth"></strong>
                            </span>
                        </div>
                    </div>
                </div>
                <!-- end left col -->

                <!-- right col -->
                <div class="event-list-tour-col-2">
                    <!-- row event period -->
                    <div class="d-flex flex-wrap">
                        <div class="small me-1"><span v-html="row.eventPeriodLgInline"></span></div>
                        <div class="small text-muted me-1">(Dauer: <span v-html="row.eventDuration"></span>)</div>
                    </div>
                    <!-- end row event period -->

                    <!-- row last minute event -->
                    <div class="last-minute-tour d-block small" v-if="row.eventType === 'lastMinuteTour'">
                        <i class="fa fa-clock"></i>
                        <span class="text-uppercase">last minute tour</span>
                    </div>
                    <!-- end row last minute event -->

                    <!-- row state icon -->
                    <div class="mt-1 title">
                        <span data-toggle="tooltip" data-placement="top" v-bind:aria-label="row.eventStateLabel" v-bind:title="row.eventStateLabel">
                            <i class="event-state-icon fa-fw" v-bind:class="row.eventState"></i>
                        </span>
                        <a v-bind:href="row.eventUrl" data-has-event-href="true" v-bind:data-href="row.eventUrl" class="event-title-link font-weight-bold"><strong><% row.eventTitle %></strong></a>
                    </div>
                    <!-- end row state icon -->

                    <!-- start row icons -->
                    <div class="d-flex">
                        <div class="me-2" v-if="row.bookingCounter" v-html="row.bookingCounter"></div>
                            <div class="me-2" v-if="row.suitableForBeginners">
                                <span class="badge badge-pill bg-warning" data-toggle="tooltip" data-placement="top" title="FÃ¼r Einsteiger geeignet">
                                    <i class="event-for-beginners"></i>
                                </span>
                            </div>
                        <div class="me-2" v-if="row.tourTechDifficulties" v-html="row.tourTechDifficulties"></div>
                        <div class="me-2" v-if="row.tourTypesShortcuts" v-html="row.tourTypesShortcuts"></div>
                    </div>
                    <!-- end row icons -->

                    <!-- start row instructors -->
                    <div class="small text-muted" v-html="row.instructors"></div>
                    <!-- end row instructors -->

                </div>
                <!-- end right col -->

                <div v-html="row.eventImage"></div>

            </div>
        </div>

    </div>

    <div v-if="blnIsBusy === true">
        <div class="d-flex mt-4 justify-content-center">
            <div class="mt-3 mb-3"><i class="fal fa-5x fa-circle-notch fa-spin"></i></div>
        </div>
        <div class="d-flex justify-content-center">
            <div class="mt-3 mb-3">... lade Events ...</div>
        </div>
    </div>

    <div v-if="blnIsBusy === false && blnAllEventsLoaded === false" v-on:click="prepareRequest()">
        <div class="d-flex justify-content-center">
            <button class="btn btn-lg btn-outline-primary mt-4 ps-5 pe-5">Weitere Events laden?</button>
        </div>
    </div>

    <div v-if="blnIsBusy === false && !itemsTotal" class="alert alert-info">
        Zu deiner Suchanfrage wurden leider keine Events gefunden.
    </div>
</div>

<!-- Set up the vue.js tour list -->
<script>
    new VueTourList('#tour-list', {
        'apiParams': {
            'organizers': [{{ apiParam.organizers|raw }}],
            'eventType': [{{ apiParam.eventType|raw }}],
            'suitableForBeginners': '{{ apiParam.suitableForBeginners|raw }}',
            'tourType': '{{ apiParam.tourType|raw }}',
            'courseType': '{{ apiParam.courseType|raw }}',
            'courseId': '{{ apiParam.courseId|raw }}',
            'year': '{{ apiParam.year|raw }}',
            'dateStart': '{{ apiParam.dateStart|raw }}',
            'textsearch': '{{ apiParam.textsearch|raw }}',
            'eventId': '{{ apiParam.eventId|raw }}',
            'arrIds': [{{ apiParam.arrIds|raw }}],
            'username': '{{ apiParam.username|raw }}',
            'calendarIds': [{{ apiParam.calendarIds|raw }}],
            'limit': '{{ apiParam.limit|raw }}',
            'offset': '0',
        },
        'fields': [
            'title',
            'startDateDay',
            'startDateMonth',
            'eventType',
            'eventTitle',
            'eventUrl',
            'instructors',
            'tourTypesShortcuts',
            'tourTechDifficulties',
            'bookingCounter',
            'id',
            'eventState',
            'eventStateLabel',
            'eventDuration',
            'eventPeriodLgInline',
            'tourTypesIds',
            'suitableForBeginners',
        ],
        'callbacks': {
            'oninsert': function (vue, json) {
                window.setTimeout(function () {
                    jQuery('[data-toggle="tooltip"]').tooltip();
                }, 200);

                window.setTimeout(function () {

                    // Cache the event list object in the localStorage
                    // before redirecting to the detail page
                    let buttons = document.querySelectorAll('[data-has-event-href="true"]');
                    buttons.forEach((button) => {
                        button.addEventListener('click', (event) => {
                            event.stopPropagation();
                            event.preventDefault();
                            let link = button.getAttribute('data-href');

                            let eventBox = button.closest('.event-item');
                            let eventId = eventBox.dataset.id;

                            let url = new URL(window.location.href);
                            let urlParams = new URLSearchParams(url.search);
                            let href = window.location.protocol + '//' + window.location.hostname + window.location.pathname;

                            if (urlParams.has('itemId')) {
                                urlParams.set('itemId', eventId);
                            } else {
                                urlParams.append('itemId', eventId);
                            }

                            // Current URL: https://my-website.com/page_a.html?event=200
                            const nextURL = href + '?' + urlParams.toString();
                            const nextTitle = document.title; // keep the same title

                            // This will create a new entry in the browser's history, without reloading
                            window.history.replaceState({}, nextTitle, nextURL);

                            let vueInstance = {
                                'rows': vue.rows,
                                'arrEventIds': vue.arrEventIds,
                                'itemsTotal': vue.itemsTotal,
                                'loadedItems': vue.loadedItems,
                                'blnAllEventsLoaded': vue.blnAllEventsLoaded,
                                'expiry': Date.now() + 5 * 60 * 1000,
                            }

                            localStorage.setItem(btoa(nextURL), JSON.stringify(vueInstance));

                            // Redirect to detail page
                            window.location.href = link;

                        });
                    });
                }, 200);
            }
        },
    });
</script>
